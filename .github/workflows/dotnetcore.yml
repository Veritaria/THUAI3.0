name: .NET Core

on: 
  push:
    branches: 
    - master
    - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
#     needs: build
    steps:
      - uses: actions/checkout@v1
      - name: Log in to DockerHub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_ACCESS_TOKEN }}
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.0.100

      - name: Setup Protobuf
        run: sudo apt-get install --no-install-recommends -y libprotobuf-dev
      - name: Make Protobuf
        run: |
            wget https://github.com/protocolbuffers/protobuf/releases/download/v3.8.0-rc1/protobuf-cpp-3.8.0-rc-1.tar.gz --no-check-certificate
            tar -zxvf protobuf-cpp-3.8.0-rc-1.tar.gz
            rm protobuf-cpp-3.8.0-rc-1.tar.gz
            cd protobuf-3.8.0-rc-1
            ./configure --prefix=/home/runner/work/THUAI3.0/THUAI3.0/protobuf
            make
            make install
            rm -rf ./protobuf-3.8.0-rc-1

      - name: Download HP-Socket
        run: |
            wget https://github.com/ldcsaa/HP-Socket/archive/v5.7.1.tar.gz --no-check-certificate
            tar -zxvf v5.7.1.tar.gz
            rm  v5.7.1.tar.gz
            cp -r ./HP-Socket-5.7.1/Linux/include/hpsocket/* ./CAPI/linux_only/include
            cp -r ./HP-Socket-5.7.1/Linux/lib/hpsocket/x64/libhpsocket.a ./CAPI/linux_only/lib

      - name: Compile CAPI
        run: chmod +x ./CAPI/compile_actions.sh

      - name: Print tree
        run: |
            sudo apt-get install tree
            tree ./build

      - name: Publish server
        run: dotnet publish "logic/Logic.Server/Logic.Server.csproj" -c Release -r linux-x64 --self-contained true
      - name: Publish agent
        run: dotnet publish "communication/Agent/Communication.Agent.csproj" -c Release -r linux-x64 -f netcoreapp3.0 --self-contained true
      
      - name: Build docker image of server
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/thuai_server:latest -f logic/ServerDockerfile .
      - name: Build docker image of agent
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/thuai_agent:latest -f logic/AgentDockerfile .
      - name: Build CAPI_compile docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/thuai_compiler:latest -f CAPI/Dockerfile_compile .
      - name: Build CAPI_run docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/thuai_client:latest -f CAPI/Dockerfile_run .
      
      - name: Push images to DockerHub
        run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/thuai_server:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/thuai_agent:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/thuai_compiler:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/thuai_client:latest
